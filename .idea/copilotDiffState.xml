<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/chenhongyu/huajuan/AICreationScreen.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/chenhongyu/huajuan/AICreationScreen.kt" />
              <option name="originalContent" value="package com.chenhongyu.huajuan&#10;&#10;import android.content.Intent&#10;import android.graphics.BitmapFactory&#10;import android.net.Uri&#10;import android.widget.Toast&#10;import androidx.compose.foundation.Image&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.clickable&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.lazy.grid.GridCells&#10;import androidx.compose.foundation.lazy.grid.LazyVerticalGrid&#10;import androidx.compose.foundation.lazy.grid.items&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.automirrored.filled.ArrowBack&#10;import androidx.compose.material.icons.outlined.Menu&#10;import androidx.compose.material.icons.filled.Close&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.graphics.asImageBitmap&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.unit.dp&#10;import com.chenhongyu.huajuan.data.AppDatabase&#10;import com.chenhongyu.huajuan.data.AICreationEntity&#10;import com.chenhongyu.huajuan.data.ImageStorage&#10;import com.chenhongyu.huajuan.data.Repository&#10;import com.chenhongyu.huajuan.render.HtmlTemplateFiller&#10;import kotlinx.coroutines.Dispatchers&#10;import kotlinx.coroutines.launch&#10;import kotlinx.coroutines.withContext&#10;import java.io.File&#10;import androidx.core.content.FileProvider&#10;import androidx.compose.ui.window.Dialog&#10;import androidx.compose.foundation.rememberScrollState&#10;import androidx.compose.foundation.verticalScroll&#10;&#10;/**&#10; * AI创作页面&#10; */&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun AICreationScreen(&#10;    onMenuClick: () -&gt; Unit = {},&#10;    onBack: () -&gt; Unit = {}&#10;) {&#10;    val context = LocalContext.current&#10;    val db = remember { AppDatabase.getDatabase(context) }&#10;    val dao = remember { db.aiCreationDao() }&#10;    val repository = remember { Repository(context) }&#10;&#10;    // collect creations from Room&#10;    val creationsState = produceState&lt;List&lt;AICreationEntity&gt;&gt;(initialValue = emptyList(), key1 = dao) {&#10;        dao.getAllCreations().collect { list -&gt;&#10;            value = list&#10;        }&#10;    }&#10;&#10;    var selected by remember { mutableStateOf&lt;AICreationEntity?&gt;(null) }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            TopAppBar(&#10;                title = { Text(&quot;AI 创作&quot;) },&#10;                navigationIcon = {&#10;                    IconButton(onClick = onMenuClick) {&#10;                        Icon(Icons.Outlined.Menu, contentDescription = &quot;打开侧边栏&quot;)&#10;                    }&#10;                },&#10;                actions = {&#10;                    IconButton(onClick = onBack) {&#10;                        Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = &quot;返回&quot;)&#10;                    }&#10;                },&#10;                colors = TopAppBarDefaults.topAppBarColors(&#10;                    containerColor = MaterialTheme.colorScheme.surface,&#10;                    titleContentColor = MaterialTheme.colorScheme.onSurface,&#10;                    navigationIconContentColor = MaterialTheme.colorScheme.onSurface&#10;                )&#10;            )&#10;        },&#10;        containerColor = MaterialTheme.colorScheme.surface&#10;    ) { paddingValues -&gt;&#10;        Box(&#10;            modifier = Modifier&#10;                .padding(paddingValues)&#10;                .fillMaxSize()&#10;        ) {&#10;            val items = creationsState.value&#10;            if (items.isEmpty()) {&#10;                Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {&#10;                    Text(&quot;暂无已收藏的AI消息，长按消息可收藏为AI创作&quot;)&#10;                }&#10;            } else {&#10;                LazyVerticalGrid(&#10;                    columns = GridCells.Fixed(2),&#10;                    modifier = Modifier&#10;                        .fillMaxSize()&#10;                        .padding(8.dp),&#10;                    contentPadding = PaddingValues(4.dp)&#10;                ) {&#10;                    items(items) { item -&gt;&#10;                        AICreationCard(item = item, onClick = { selected = item })&#10;                    }&#10;                }&#10;            }&#10;&#10;            // Replace AlertDialog with full-screen detail when selected&#10;            if (selected != null) {&#10;                val item = selected!!&#10;                AICreationDetail(item = item, repository = repository, onClose = { selected = null })&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;fun AICreationCard(item: AICreationEntity, onClick: () -&gt; Unit) {&#10;    Card(&#10;        modifier = Modifier&#10;            .padding(6.dp)&#10;            .fillMaxWidth()&#10;            .clickable { onClick() },&#10;        elevation = CardDefaults.cardElevation(4.dp)&#10;    ) {&#10;        Column(modifier = Modifier.fillMaxWidth()) {&#10;            var bmp by remember { mutableStateOf&lt;android.graphics.Bitmap?&gt;(null) }&#10;            LaunchedEffect(item.imageFileName) {&#10;                if (!item.imageFileName.isNullOrEmpty()) {&#10;                    bmp = withContext(Dispatchers.IO) {&#10;                        try {&#10;                            BitmapFactory.decodeFile(item.imageFileName)&#10;                        } catch (_: Exception) {&#10;                            null&#10;                        }&#10;                    }&#10;                } else {&#10;                    bmp = null&#10;                }&#10;            }&#10;&#10;            val localBmpCard = bmp&#10;            if (localBmpCard != null) {&#10;                Image(bitmap = localBmpCard.asImageBitmap(), contentDescription = item.aiRoleName ?: &quot;AI 创建&quot;, modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .height(180.dp))&#10;            } else {&#10;                Box(modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .height(180.dp)&#10;                    .background(MaterialTheme.colorScheme.surfaceVariant), contentAlignment = Alignment.Center) {&#10;                    Text(item.aiRoleName ?: &quot;默认&quot;, fontWeight = FontWeight.Bold)&#10;                }&#10;            }&#10;&#10;            Column(modifier = Modifier.padding(8.dp)) {&#10;                Text(text = item.username ?: &quot;匿名&quot;, style = MaterialTheme.typography.bodyMedium, fontWeight = FontWeight.SemiBold)&#10;                Spacer(modifier = Modifier.height(4.dp))&#10;                Text(text = formatTimeAgo(item.createdAt), style = MaterialTheme.typography.bodySmall)&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun AICreationEditor(&#10;    message: com.chenhongyu.huajuan.data.Message,&#10;    repository: Repository,&#10;    conversationId: String,&#10;    onDismiss: () -&gt; Unit,&#10;    onPublished: (String) -&gt; Unit,&#10;    conversationMessages: List&lt;com.chenhongyu.huajuan.data.Message&gt;? = null,&#10;    conversationAt: Long? = null&#10;) {&#10;    val context = LocalContext.current&#10;    val scope = rememberCoroutineScope()&#10;&#10;    val userInfo = repository.getUserInfo()&#10;    var title by remember { mutableStateOf(&quot;来自 ${userInfo.username} 的创作&quot;) }&#10;    var commentary by remember { mutableStateOf(&quot;&quot;) }&#10;    var content by remember { mutableStateOf(message.text) }&#10;    var selectedTemplate by remember { mutableStateOf(&quot;classic&quot;) }&#10;    val templates = listOf(&quot;classic&quot;, &quot;poem&quot;, &quot;card&quot;, &quot;dialog&quot;)&#10;    var includeConversation by remember { mutableStateOf(true) }&#10;    var publishedAt by remember { mutableStateOf(conversationAt ?: System.currentTimeMillis()) }&#10;&#10;    // track the current created entity id so we can publish later&#10;    var currentCreationId by remember { mutableStateOf&lt;String?&gt;(null) }&#10;&#10;    var previewBmp by remember { mutableStateOf&lt;android.graphics.Bitmap?&gt;(null) }&#10;    var isGenerating by remember { mutableStateOf(false) }&#10;&#10;    Dialog(onDismissRequest = onDismiss) {&#10;        Surface(modifier = Modifier.fillMaxSize(), color = MaterialTheme.colorScheme.background) {&#10;            Scaffold(&#10;                topBar = {&#10;                    TopAppBar(&#10;                        title = { Text(&quot;发布到 AI 创作&quot;) },&#10;                        navigationIcon = {&#10;                            IconButton(onClick = onDismiss) {&#10;                                Icon(Icons.Default.Close, contentDescription = &quot;关闭&quot;)&#10;                            }&#10;                        }&#10;                    )&#10;                }&#10;            ) { padding -&gt;&#10;                Column(modifier = Modifier&#10;                    .padding(padding)&#10;                    .padding(16.dp)&#10;                    .fillMaxSize(), verticalArrangement = Arrangement.Top) {&#10;&#10;                    // header info: username, ai role, times&#10;                    Text(text = &quot;发布者: ${userInfo.username}&quot;, style = MaterialTheme.typography.bodyMedium, fontWeight = FontWeight.SemiBold)&#10;                    Text(text = &quot;AI 角色: ${repository.getConversationRoleName(conversationId)}&quot;, style = MaterialTheme.typography.bodySmall)&#10;                    Spacer(modifier = Modifier.height(6.dp))&#10;                    val convStart = conversationMessages?.firstOrNull()?.timestamp ?: (conversationAt?.let { java.util.Date(it) })&#10;                    if (convStart != null) {&#10;                        Text(text = &quot;对话时间: ${formatConversationTime(convStart)}&quot;, style = MaterialTheme.typography.bodySmall)&#10;                    }&#10;                    Text(text = &quot;发布时间: ${formatTime(java.util.Date(publishedAt))}&quot;, style = MaterialTheme.typography.bodySmall)&#10;&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                    OutlinedTextField(&#10;                        value = title,&#10;                        onValueChange = { title = it },&#10;                        label = { Text(&quot;帖子标题&quot;) },&#10;                        singleLine = true,&#10;                        modifier = Modifier.fillMaxWidth()&#10;                    )&#10;&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                    OutlinedTextField(&#10;                        value = commentary,&#10;                        onValueChange = { commentary = it },&#10;                        label = { Text(&quot;吐槽 / 感想 (帖子正文) &quot;) },&#10;                        modifier = Modifier.fillMaxWidth().heightIn(min = 120.dp),&#10;                        maxLines = 6&#10;                    )&#10;&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                    Row(verticalAlignment = Alignment.CenterVertically) {&#10;                        Checkbox(checked = includeConversation, onCheckedChange = { includeConversation = it })&#10;                        Text(text = &quot;包含对话内容&quot;)&#10;                    }&#10;&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                    Text(text = &quot;选择模板&quot;, style = MaterialTheme.typography.titleSmall)&#10;                    Spacer(modifier = Modifier.height(4.dp))&#10;                    Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                        templates.forEach { t -&gt;&#10;                            FilterChip(&#10;                                selected = (t == selectedTemplate),&#10;                                onClick = { selectedTemplate = t },&#10;                                label = { Text(t) }&#10;                            )&#10;                        }&#10;                    }&#10;&#10;                    Spacer(modifier = Modifier.height(12.dp))&#10;&#10;                    // preview area&#10;                    Box(modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .height(220.dp)&#10;                        .background(MaterialTheme.colorScheme.surfaceVariant), contentAlignment = Alignment.Center) {&#10;                        if (previewBmp != null) {&#10;                            Image(bitmap = previewBmp!!.asImageBitmap(), contentDescription = &quot;封面预览&quot;, modifier = Modifier.fillMaxSize())&#10;                        } else {&#10;                            Text(if (isGenerating) &quot;正在生成封面...&quot; else &quot;尚未生成封面（封面将作为帖子封面）&quot;)&#10;                        }&#10;                    }&#10;&#10;                    Spacer(modifier = Modifier.height(12.dp))&#10;&#10;                    Row(horizontalArrangement = Arrangement.End, modifier = Modifier.fillMaxWidth()) {&#10;                        TextButton(onClick = onDismiss) { Text(&quot;取消&quot;) }&#10;                        Spacer(modifier = Modifier.width(8.dp))&#10;&#10;                        // Button: 生成预览&#10;                        TextButton(onClick = {&#10;                            scope.launch {&#10;                                try {&#10;                                    isGenerating = true&#10;                                    val convText = if (includeConversation &amp;&amp; conversationMessages != null) {&#10;                                        conversationMessages.joinToString(separator = &quot;\n&quot;) { m -&gt;&#10;                                            val who = if (m.isUser) repository.getUserInfo().username else repository.getConversationRoleName(conversationId)&#10;                                            &quot;[${who}] ${m.text}&quot;&#10;                                        }&#10;                                    } else null&#10;&#10;                                    val promptHtml = when (selectedTemplate) {&#10;                                        &quot;poem&quot; -&gt; &quot;&lt;div style=\&quot;font-family: serif; padding:24px; text-align:center;\&quot;&gt;&lt;h2&gt;${title}&lt;/h2&gt;&lt;p&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/p&gt;&lt;footer style=\&quot;margin-top:16px;opacity:0.7;\&quot;&gt;— ${userInfo.username}&lt;/footer&gt;&lt;/div&gt;&quot;&#10;                                        &quot;card&quot; -&gt; &quot;&lt;div style=\&quot;font-family: sans-serif; padding:20px; border:1px solid #eee; border-radius:12px;\&quot;&gt;&lt;h3&gt;${title}&lt;/h3&gt;&lt;div&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/div&gt;&lt;/div&gt;&quot;&#10;                                        &quot;dialog&quot; -&gt; {&#10;                                            // load template from assets and fill with data&#10;                                            try {&#10;                                                val tpl = context.assets.open(&quot;ai_templates/dialog.html&quot;).bufferedReader().use { it.readText() }&#10;                                                val dataMap = mapOf(&#10;                                                    &quot;time&quot; to java.text.SimpleDateFormat(&quot;MMM dd, yyyy · HH:mm&quot;, java.util.Locale.getDefault()).format(java.util.Date(publishedAt)),&#10;                                                    &quot;userName&quot; to (userInfo.username ?: &quot;&quot;),&#10;                                                    &quot;userSig&quot; to (userInfo.signature ?: &quot;&quot;),&#10;                                                    &quot;aiName&quot; to repository.getConversationRoleName(conversationId),&#10;                                                    &quot;aiModel&quot; to repository.getSelectedModel(),&#10;                                                    &quot;aiPrompt&quot; to commentary,&#10;                                                    &quot;userContent&quot; to (convText ?: content),&#10;                                                    &quot;aiContent&quot; to &quot;&quot;&#10;                                                )&#10;                                                HtmlTemplateFiller.fillTemplate(tpl, dataMap)&#10;                                            } catch (e: Exception) {&#10;                                                // fallback to simple card HTML&#10;                                                &quot;&lt;div style=\&quot;font-family: system-ui; padding:16px;\&quot;&gt;&lt;h3&gt;${title}&lt;/h3&gt;&lt;div&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/div&gt;&lt;/div&gt;&quot;&#10;                                            }&#10;                                        }&#10;                                        else -&gt; &quot;&lt;div style=\&quot;font-family: system-ui; padding:16px;\&quot;&gt;&lt;h3&gt;${title}&lt;/h3&gt;&lt;div&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/div&gt;&lt;/div&gt;&quot;&#10;                                    }&#10;&#10;                                    val id = repository.createAICreationFromMessage(&#10;                                        title = title,&#10;                                        username = repository.getUserInfo().username,&#10;                                        userSignature = repository.getUserInfo().signature,&#10;                                        aiRoleName = repository.getConversationRoleName(conversationId),&#10;                                        aiModelName = repository.getSelectedModel(),&#10;                                        promptHtml = promptHtml,&#10;                                        promptJson = &quot;{\&quot;sourceConversationId\&quot;: \&quot;$conversationId\&quot;, \&quot;messageId\&quot;: \&quot;${message.id}\&quot;}&quot;,&#10;                                        conversationText = convText ?: content,&#10;                                        conversationAt = conversationAt,&#10;                                        publishedAt = publishedAt,&#10;                                        commentary = commentary&#10;                                    )&#10;&#10;                                    // remember id for publishing later&#10;                                    currentCreationId = id&#10;&#10;                                    // generate synchronously to get image immediately for preview&#10;                                    val ok = repository.generateAICreationNow(id)&#10;                                    if (ok) {&#10;                                        // load entity image path&#10;                                        val dao = AppDatabase.getDatabase(context).aiCreationDao()&#10;                                        val ent = withContext(Dispatchers.IO) { dao.getCreationById(id) }&#10;                                        val imgPath = ent?.imageFileName&#10;                                        if (!imgPath.isNullOrEmpty()) {&#10;                                            previewBmp = withContext(Dispatchers.IO) {&#10;                                                try {&#10;                                                    BitmapFactory.decodeFile(imgPath)&#10;                                                } catch (_: Exception) {&#10;                                                    null&#10;                                                }&#10;                                            }&#10;                                        } else {&#10;                                            previewBmp = null&#10;                                        }&#10;                                    } else {&#10;                                        withContext(Dispatchers.Main) {&#10;                                            Toast.makeText(context, &quot;生成失败，请稍后重试&quot;, Toast.LENGTH_SHORT).show()&#10;                                        }&#10;                                    }&#10;                                } catch (e: Exception) {&#10;                                    e.printStackTrace()&#10;                                    Toast.makeText(context, &quot;生成错误: ${e.message}&quot;, Toast.LENGTH_SHORT).show()&#10;                                } finally {&#10;                                    isGenerating = false&#10;                                }&#10;                            }&#10;                        }) { Text(&quot;生成预览&quot;) }&#10;&#10;                        Spacer(modifier = Modifier.width(8.dp))&#10;&#10;                        // Button: 发布（确保生成并标记为已发布）&#10;                        Button(onClick = {&#10;                            scope.launch {&#10;                                try {&#10;                                    isGenerating = true&#10;                                    // ensure we have an entity id&#10;                                    val id = currentCreationId ?: run {&#10;                                        val convText = if (includeConversation &amp;&amp; conversationMessages != null) {&#10;                                            conversationMessages.joinToString(separator = &quot;\n&quot;) { m -&gt;&#10;                                                val who = if (m.isUser) repository.getUserInfo().username else repository.getConversationRoleName(conversationId)&#10;                                                &quot;[${who}] ${m.text}&quot;&#10;                                            }&#10;                                        } else null&#10;&#10;                                        val promptHtml = when (selectedTemplate) {&#10;                                            &quot;poem&quot; -&gt; &quot;&lt;div style=\&quot;font-family: serif; padding:24px; text-align:center;\&quot;&gt;&lt;h2&gt;${title}&lt;/h2&gt;&lt;p&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/p&gt;&lt;footer style=\&quot;margin-top:16px;opacity:0.7;\&quot;&gt;— ${userInfo.username}&lt;/footer&gt;&lt;/div&gt;&quot;&#10;                                            &quot;card&quot; -&gt; &quot;&lt;div style=\&quot;font-family: sans-serif; padding:20px; border:1px solid #eee; border-radius:12px;\&quot;&gt;&lt;h3&gt;${title}&lt;/h3&gt;&lt;div&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/div&gt;&lt;/div&gt;&quot;&#10;                                            &quot;dialog&quot; -&gt; {&#10;                                                // load template from assets and fill with data&#10;                                                try {&#10;                                                    val tpl = context.assets.open(&quot;ai_templates/dialog.html&quot;).bufferedReader().use { it.readText() }&#10;                                                    val dataMap = mapOf(&#10;                                                        &quot;time&quot; to java.text.SimpleDateFormat(&quot;MMM dd, yyyy · HH:mm&quot;, java.util.Locale.getDefault()).format(java.util.Date(publishedAt)),&#10;                                                        &quot;userName&quot; to (userInfo.username ?: &quot;&quot;),&#10;                                                        &quot;userSig&quot; to (userInfo.signature ?: &quot;&quot;),&#10;                                                        &quot;aiName&quot; to repository.getConversationRoleName(conversationId),&#10;                                                        &quot;aiModel&quot; to repository.getSelectedModel(),&#10;                                                        &quot;aiPrompt&quot; to commentary,&#10;                                                        &quot;userContent&quot; to (convText ?: content),&#10;                                                        &quot;aiContent&quot; to &quot;&quot;&#10;                                                    )&#10;                                                    HtmlTemplateFiller.fillTemplate(tpl, dataMap)&#10;                                                } catch (e: Exception) {&#10;                                                    // fallback to simple card HTML&#10;                                                    &quot;&lt;div style=\&quot;font-family: system-ui; padding:16px;\&quot;&gt;&lt;h3&gt;${title}&lt;/h3&gt;&lt;div&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/div&gt;&lt;/div&gt;&quot;&#10;                                                }&#10;                                            }&#10;                                            else -&gt; &quot;&lt;div style=\&quot;font-family: system-ui; padding:16px;\&quot;&gt;&lt;h3&gt;${title}&lt;/h3&gt;&lt;div&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/div&gt;&lt;/div&gt;&quot;&#10;                                        }&#10;&#10;                                        repository.createAICreationFromMessage(&#10;                                            title = title,&#10;                                            username = repository.getUserInfo().username,&#10;                                            userSignature = repository.getUserInfo().signature,&#10;                                            aiRoleName = repository.getConversationRoleName(conversationId),&#10;                                            aiModelName = repository.getSelectedModel(),&#10;                                            promptHtml = promptHtml,&#10;                                            promptJson = &quot;{\&quot;sourceConversationId\&quot;: \&quot;$conversationId\&quot;, \&quot;messageId\&quot;: \&quot;${message.id}\&quot;}&quot;,&#10;                                            conversationText = convText ?: content,&#10;                                            conversationAt = conversationAt,&#10;                                            publishedAt = publishedAt,&#10;                                            commentary = commentary&#10;                                        )&#10;                                    }&#10;&#10;                                    // Generate if image missing&#10;                                    val dao = AppDatabase.getDatabase(context).aiCreationDao()&#10;                                    val ent = withContext(Dispatchers.IO) { dao.getCreationById(id) }&#10;                                    if (ent == null) {&#10;                                        withContext(Dispatchers.Main) {&#10;                                            Toast.makeText(context, &quot;创建失败&quot;, Toast.LENGTH_SHORT).show()&#10;                                        }&#10;                                        return@launch&#10;                                    }&#10;&#10;                                    if (ent.imageFileName.isNullOrEmpty()) {&#10;                                        val genOk = repository.generateAICreationNow(id)&#10;                                        if (!genOk) {&#10;                                            withContext(Dispatchers.Main) {&#10;                                                Toast.makeText(context, &quot;生成封面失败，已加入队列&quot;, Toast.LENGTH_SHORT).show()&#10;                                            }&#10;                                            // enqueue for background generation and still publish the post&#10;                                            repository.enqueueAICreationGeneration(id)&#10;                                        }&#10;                                    }&#10;&#10;                                    // mark published (suspend)&#10;                                    withContext(Dispatchers.IO) {&#10;                                        repository.publishAICreation(id)&#10;                                    }&#10;&#10;                                    // callback on main thread&#10;                                    withContext(Dispatchers.Main) {&#10;                                        onPublished(id)&#10;                                        Toast.makeText(context, &quot;已发布到 AI 创作&quot;, Toast.LENGTH_SHORT).show()&#10;                                    }&#10;&#10;                                    // dismiss editor&#10;                                    onDismiss()&#10;&#10;                                } catch (e: Exception) {&#10;                                    e.printStackTrace()&#10;                                    withContext(Dispatchers.Main) {&#10;                                        Toast.makeText(context, &quot;发布失败: ${e.message}&quot;, Toast.LENGTH_SHORT).show()&#10;                                    }&#10;                                } finally {&#10;                                    isGenerating = false&#10;                                }&#10;                            }&#10;                        }) {&#10;                            Text(&quot;发布并发布到 AI 创作&quot;)&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun AICreationDetail(&#10;    item: AICreationEntity,&#10;    repository: Repository,&#10;    onClose: () -&gt; Unit&#10;) {&#10;    val context = LocalContext.current&#10;    val scope = rememberCoroutineScope()&#10;    Dialog(onDismissRequest = onClose) {&#10;        Surface(modifier = Modifier.fillMaxSize(), color = MaterialTheme.colorScheme.background) {&#10;            Column(modifier = Modifier&#10;                .fillMaxSize()&#10;                .padding(0.dp)) {&#10;                TopAppBar(&#10;                    title = { Text(item.aiRoleName ?: &quot;AI 创作&quot;) },&#10;                    navigationIcon = {&#10;                        IconButton(onClick = onClose) {&#10;                            Icon(Icons.Default.Close, contentDescription = &quot;关闭&quot;)&#10;                        }&#10;                    }&#10;                )&#10;&#10;                val scroll = rememberScrollState()&#10;                Column(modifier = Modifier&#10;                    .fillMaxSize()&#10;                    .verticalScroll(scroll)&#10;                    .padding(16.dp)) {&#10;&#10;                    // Cover image&#10;                    val bmp = item.imageFileName?.let { ImageStorage.loadBitmap(it) }&#10;                    if (bmp != null) {&#10;                        Image(bitmap = bmp.asImageBitmap(), contentDescription = &quot;题图&quot;, modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .height(420.dp))&#10;                    } else {&#10;                        Box(modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .height(420.dp)&#10;                            .background(MaterialTheme.colorScheme.surfaceVariant), contentAlignment = Alignment.Center) {&#10;                            Text(&quot;尚未生成题图&quot;)&#10;                        }&#10;                    }&#10;&#10;                    Spacer(modifier = Modifier.height(12.dp))&#10;&#10;                    Text(text = item.title ?: &quot;无标题&quot;, style = MaterialTheme.typography.headlineSmall, fontWeight = FontWeight.Bold)&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                    Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {&#10;                        Text(text = &quot;作者: ${item.username ?: &quot;匿名&quot;}&quot;, style = MaterialTheme.typography.bodyMedium)&#10;                        Text(text = &quot;AI 角色: ${item.aiRoleName ?: &quot;-&quot;}&quot;, style = MaterialTheme.typography.bodySmall)&#10;                    }&#10;&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                    Text(text = &quot;对话时间: ${item.conversationAt?.let { formatTime(java.util.Date(it)) } ?: &quot;-&quot;}&quot;)&#10;                    Text(text = &quot;发布时间: ${item.publishedAt?.let { formatTime(java.util.Date(it)) } ?: formatTime(java.util.Date(item.createdAt))}&quot;)&#10;&#10;                    Spacer(modifier = Modifier.height(12.dp))&#10;&#10;                    if (!item.commentary.isNullOrEmpty()) {&#10;                        Text(text = &quot;帖子正文&quot;, style = MaterialTheme.typography.titleMedium)&#10;                        Spacer(modifier = Modifier.height(4.dp))&#10;                        Text(text = item.commentary!!, style = MaterialTheme.typography.bodyMedium)&#10;                        Spacer(modifier = Modifier.height(12.dp))&#10;                    }&#10;&#10;                    val convText = item.conversationText&#10;                    if (!convText.isNullOrEmpty()) {&#10;                        Text(text = &quot;对话内容&quot;, style = MaterialTheme.typography.titleMedium)&#10;                        Spacer(modifier = Modifier.height(4.dp))&#10;                        Text(text = convText, style = MaterialTheme.typography.bodySmall)&#10;                        Spacer(modifier = Modifier.height(12.dp))&#10;                    }&#10;&#10;                    // Actions: regenerate, share, delete&#10;                    Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.End) {&#10;                        TextButton(onClick = {&#10;                            scope.launch {&#10;                                repository.enqueueAICreationGeneration(item.id)&#10;                                Toast.makeText(context, &quot;已开始重新生成&quot;, Toast.LENGTH_SHORT).show()&#10;                                onClose()&#10;                            }&#10;                        }) { Text(&quot;重新生成&quot;) }&#10;&#10;                        Spacer(modifier = Modifier.width(8.dp))&#10;&#10;                        TextButton(onClick = {&#10;                            try {&#10;                                val f = File(item.imageFileName ?: &quot;&quot;)&#10;                                if (f.exists()) {&#10;                                    val authority = &quot;com.chenhongyu.huajuan.fileprovider&quot;&#10;                                    val uri: Uri = FileProvider.getUriForFile(context, authority, f)&#10;                                    val shareIntent = Intent(Intent.ACTION_SEND).apply {&#10;                                        type = &quot;image/*&quot;&#10;                                        putExtra(Intent.EXTRA_STREAM, uri)&#10;                                        addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)&#10;                                    }&#10;                                    val chooser = Intent.createChooser(shareIntent, &quot;分享图片&quot;)&#10;                                    chooser.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)&#10;                                    context.startActivity(chooser)&#10;                                } else {&#10;                                    Toast.makeText(context, &quot;图片不存在，无法分享&quot;, Toast.LENGTH_SHORT).show()&#10;                                }&#10;                            } catch (_: Exception) {&#10;                                Toast.makeText(context, &quot;分享失败&quot;, Toast.LENGTH_SHORT).show()&#10;                            }&#10;                        }) { Text(&quot;分享&quot;) }&#10;&#10;                        Spacer(modifier = Modifier.width(8.dp))&#10;&#10;                        TextButton(onClick = {&#10;                            scope.launch {&#10;                                try {&#10;                                    repository.deleteAICreation(item.id)&#10;                                    Toast.makeText(context, &quot;已删除&quot;, Toast.LENGTH_SHORT).show()&#10;                                } catch (_: Exception) {&#10;                                    Toast.makeText(context, &quot;删除失败&quot;, Toast.LENGTH_SHORT).show()&#10;                                } finally {&#10;                                    onClose()&#10;                                }&#10;                            }&#10;                        }) { Text(&quot;删除&quot;) }&#10;                    }&#10;&#10;                    Spacer(modifier = Modifier.height(24.dp))&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.chenhongyu.huajuan&#10;&#10;import android.content.Intent&#10;import android.graphics.BitmapFactory&#10;import android.net.Uri&#10;import android.widget.Toast&#10;import androidx.compose.foundation.Image&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.clickable&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.lazy.grid.GridCells&#10;import androidx.compose.foundation.lazy.grid.LazyVerticalGrid&#10;import androidx.compose.foundation.lazy.grid.items&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.automirrored.filled.ArrowBack&#10;import androidx.compose.material.icons.outlined.Menu&#10;import androidx.compose.material.icons.filled.Close&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.graphics.asImageBitmap&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.unit.dp&#10;import com.chenhongyu.huajuan.data.AppDatabase&#10;import com.chenhongyu.huajuan.data.AICreationEntity&#10;import com.chenhongyu.huajuan.data.ImageStorage&#10;import com.chenhongyu.huajuan.data.Repository&#10;import com.chenhongyu.huajuan.render.HtmlTemplateFiller&#10;import kotlinx.coroutines.Dispatchers&#10;import kotlinx.coroutines.launch&#10;import kotlinx.coroutines.withContext&#10;import java.io.File&#10;import androidx.core.content.FileProvider&#10;import androidx.compose.ui.window.Dialog&#10;import androidx.compose.foundation.rememberScrollState&#10;import androidx.compose.foundation.verticalScroll&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;&#10;/**&#10; * AI创作页面&#10; */&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun AICreationScreen(&#10;    onMenuClick: () -&gt; Unit = {},&#10;    onBack: () -&gt; Unit = {}&#10;) {&#10;    val context = LocalContext.current&#10;    val db = remember { AppDatabase.getDatabase(context) }&#10;    val dao = remember { db.aiCreationDao() }&#10;    val repository = remember { Repository(context) }&#10;&#10;    // collect creations from Room&#10;    val creationsState = produceState&lt;List&lt;AICreationEntity&gt;&gt;(initialValue = emptyList(), key1 = dao) {&#10;        dao.getAllCreations().collect { list -&gt;&#10;            value = list&#10;        }&#10;    }&#10;&#10;    var selected by remember { mutableStateOf&lt;AICreationEntity?&gt;(null) }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            TopAppBar(&#10;                title = { Text(&quot;AI 创作&quot;) },&#10;                navigationIcon = {&#10;                    IconButton(onClick = onMenuClick) {&#10;                        Icon(Icons.Outlined.Menu, contentDescription = &quot;打开侧边栏&quot;)&#10;                    }&#10;                },&#10;                actions = {&#10;                    IconButton(onClick = onBack) {&#10;                        Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = &quot;返回&quot;)&#10;                    }&#10;                },&#10;                colors = TopAppBarDefaults.topAppBarColors(&#10;                    containerColor = MaterialTheme.colorScheme.surface,&#10;                    titleContentColor = MaterialTheme.colorScheme.onSurface,&#10;                    navigationIconContentColor = MaterialTheme.colorScheme.onSurface&#10;                )&#10;            )&#10;        },&#10;        containerColor = MaterialTheme.colorScheme.surface&#10;    ) { paddingValues -&gt;&#10;        Box(&#10;            modifier = Modifier&#10;                .padding(paddingValues)&#10;                .fillMaxSize()&#10;        ) {&#10;            val items = creationsState.value&#10;            if (items.isEmpty()) {&#10;                Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {&#10;                    Text(&quot;暂无已收藏的AI消息，长按消息可收藏为AI创作&quot;)&#10;                }&#10;            } else {&#10;                LazyVerticalGrid(&#10;                    columns = GridCells.Fixed(2),&#10;                    modifier = Modifier&#10;                        .fillMaxSize()&#10;                        .padding(4.dp), // reduce outer padding for denser modern look&#10;                    contentPadding = PaddingValues(2.dp) // smaller gaps between items&#10;                ) {&#10;                    items(items) { item -&gt;&#10;                        AICreationCard(item = item, onClick = { selected = item })&#10;                    }&#10;                }&#10;            }&#10;&#10;            // Replace AlertDialog with full-screen detail when selected&#10;            if (selected != null) {&#10;                val item = selected!!&#10;                AICreationDetail(item = item, repository = repository, onClose = { selected = null })&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;fun AICreationCard(item: AICreationEntity, onClick: () -&gt; Unit) {&#10;    Card(&#10;        modifier = Modifier&#10;            .padding(4.dp) // smaller card padding&#10;            .fillMaxWidth()&#10;            .clickable { onClick() },&#10;        elevation = CardDefaults.cardElevation(6.dp),&#10;        shape = RoundedCornerShape(8.dp) // smaller rounded corners&#10;    ) {&#10;        Column(modifier = Modifier.fillMaxWidth()) {&#10;            var bmp by remember { mutableStateOf&lt;android.graphics.Bitmap?&gt;(null) }&#10;            LaunchedEffect(item.imageFileName) {&#10;                if (!item.imageFileName.isNullOrEmpty()) {&#10;                    bmp = withContext(Dispatchers.IO) {&#10;                        try {&#10;                            BitmapFactory.decodeFile(item.imageFileName)&#10;                        } catch (_: Exception) {&#10;                            null&#10;                        }&#10;                    }&#10;                } else {&#10;                    bmp = null&#10;                }&#10;            }&#10;&#10;            val localBmpCard = bmp&#10;&#10;            // Image area with overlayed author/time (主展示放在图片上)&#10;            Box(modifier = Modifier&#10;                .fillMaxWidth()&#10;                .height(160.dp)) {&#10;                if (localBmpCard != null) {&#10;                    Image(&#10;                        bitmap = localBmpCard.asImageBitmap(),&#10;                        contentDescription = item.aiRoleName ?: &quot;AI 创建&quot;,&#10;                        modifier = Modifier&#10;                            .fillMaxSize()&#10;                    )&#10;                } else {&#10;                    Box(modifier = Modifier&#10;                        .fillMaxSize()&#10;                        .background(MaterialTheme.colorScheme.surfaceVariant), contentAlignment = Alignment.Center) {&#10;                        Text(item.aiRoleName ?: &quot;默认&quot;, fontWeight = FontWeight.Bold, color = MaterialTheme.colorScheme.onSurface)&#10;                    }&#10;                }&#10;&#10;                // Overlay box at bottom of image&#10;                Box(modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .height(56.dp)&#10;                    .align(Alignment.BottomStart)&#10;                    .background(MaterialTheme.colorScheme.surface.copy(alpha = 0.6f))) {&#10;                    Column(modifier = Modifier&#10;                        .padding(start = 10.dp, top = 6.dp, bottom = 6.dp), verticalArrangement = Arrangement.Center) {&#10;                        Text(text = item.username ?: &quot;匿名&quot;, style = MaterialTheme.typography.bodyMedium, fontWeight = FontWeight.SemiBold, color = MaterialTheme.colorScheme.onSurface)&#10;                        Spacer(modifier = Modifier.height(2.dp))&#10;                        Text(text = formatTimeAgo(item.createdAt), style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurface)&#10;                    }&#10;                }&#10;            }&#10;&#10;            // ...existing code... (removed extra large paddings under image)&#10;            Spacer(modifier = Modifier.height(6.dp))&#10;        }&#10;    }&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun AICreationEditor(&#10;    message: com.chenhongyu.huajuan.data.Message,&#10;    repository: Repository,&#10;    conversationId: String,&#10;    onDismiss: () -&gt; Unit,&#10;    onPublished: (String) -&gt; Unit,&#10;    conversationMessages: List&lt;com.chenhongyu.huajuan.data.Message&gt;? = null,&#10;    conversationAt: Long? = null&#10;) {&#10;    val context = LocalContext.current&#10;    val scope = rememberCoroutineScope()&#10;&#10;    val userInfo = repository.getUserInfo()&#10;    var title by remember { mutableStateOf(&quot;来自 ${userInfo.username} 的创作&quot;) }&#10;    var commentary by remember { mutableStateOf(&quot;&quot;) }&#10;    var content by remember { mutableStateOf(message.text) }&#10;    var selectedTemplate by remember { mutableStateOf(&quot;classic&quot;) }&#10;    val templates = listOf(&quot;classic&quot;, &quot;poem&quot;, &quot;card&quot;, &quot;dialog&quot;)&#10;    var includeConversation by remember { mutableStateOf(true) }&#10;    var publishedAt by remember { mutableStateOf(conversationAt ?: System.currentTimeMillis()) }&#10;&#10;    // track the current created entity id so we can publish later&#10;    var currentCreationId by remember { mutableStateOf&lt;String?&gt;(null) }&#10;&#10;    var previewBmp by remember { mutableStateOf&lt;android.graphics.Bitmap?&gt;(null) }&#10;    var isGenerating by remember { mutableStateOf(false) }&#10;&#10;    Dialog(onDismissRequest = onDismiss) {&#10;        Surface(modifier = Modifier.fillMaxSize(), color = MaterialTheme.colorScheme.background) {&#10;            Scaffold(&#10;                topBar = {&#10;                    TopAppBar(&#10;                        title = { Text(&quot;发布到 AI 创作&quot;) },&#10;                        navigationIcon = {&#10;                            IconButton(onClick = onDismiss) {&#10;                                Icon(Icons.Default.Close, contentDescription = &quot;关闭&quot;)&#10;                            }&#10;                        }&#10;                    )&#10;                }&#10;            ) { padding -&gt;&#10;                Column(modifier = Modifier&#10;                    .padding(padding)&#10;                    .padding(12.dp) // slightly reduced padding&#10;                    .fillMaxSize(), verticalArrangement = Arrangement.Top) {&#10;&#10;                    // header info: username, ai role, times&#10;                    Text(text = &quot;发布者: ${userInfo.username}&quot;, style = MaterialTheme.typography.bodyMedium, fontWeight = FontWeight.SemiBold)&#10;                    Text(text = &quot;AI 角色: ${repository.getConversationRoleName(conversationId)}&quot;, style = MaterialTheme.typography.bodySmall)&#10;                    Spacer(modifier = Modifier.height(6.dp))&#10;                    val convStart = conversationMessages?.firstOrNull()?.timestamp ?: (conversationAt?.let { java.util.Date(it) })&#10;                    if (convStart != null) {&#10;                        Text(text = &quot;对话时间: ${formatConversationTime(convStart)}&quot;, style = MaterialTheme.typography.bodySmall)&#10;                    }&#10;                    Text(text = &quot;发布时间: ${formatTime(java.util.Date(publishedAt))}&quot;, style = MaterialTheme.typography.bodySmall)&#10;&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                    OutlinedTextField(&#10;                        value = title,&#10;                        onValueChange = { title = it },&#10;                        label = { Text(&quot;帖子标题&quot;) },&#10;                        singleLine = true,&#10;                        modifier = Modifier.fillMaxWidth()&#10;                    )&#10;&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                    OutlinedTextField(&#10;                        value = commentary,&#10;                        onValueChange = { commentary = it },&#10;                        label = { Text(&quot;吐槽 / 感想 (帖子正文) &quot;) },&#10;                        modifier = Modifier.fillMaxWidth().heightIn(min = 120.dp),&#10;                        maxLines = 6&#10;                    )&#10;&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                    Row(verticalAlignment = Alignment.CenterVertically) {&#10;                        Checkbox(checked = includeConversation, onCheckedChange = { includeConversation = it })&#10;                        Text(text = &quot;包含对话内容&quot;)&#10;                    }&#10;&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                    Text(text = &quot;选择模板&quot;, style = MaterialTheme.typography.titleSmall)&#10;                    Spacer(modifier = Modifier.height(4.dp))&#10;                    Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                        templates.forEach { t -&gt;&#10;                            FilterChip(&#10;                                selected = (t == selectedTemplate),&#10;                                onClick = { selectedTemplate = t },&#10;                                label = { Text(t) }&#10;                            )&#10;                        }&#10;                    }&#10;&#10;                    Spacer(modifier = Modifier.height(12.dp))&#10;&#10;                    // preview area&#10;                    Box(modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .height(220.dp)&#10;                        .background(MaterialTheme.colorScheme.surfaceVariant), contentAlignment = Alignment.Center) {&#10;                        if (previewBmp != null) {&#10;                            Image(bitmap = previewBmp!!.asImageBitmap(), contentDescription = &quot;封面预览&quot;, modifier = Modifier.fillMaxSize())&#10;                        } else {&#10;                            Text(if (isGenerating) &quot;正在生成封面...&quot; else &quot;尚未生成封面（封面将作为帖子封面）&quot;)&#10;                        }&#10;                    }&#10;&#10;                    Spacer(modifier = Modifier.height(12.dp))&#10;&#10;                    Row(horizontalArrangement = Arrangement.End, modifier = Modifier.fillMaxWidth()) {&#10;                        TextButton(onClick = onDismiss) { Text(&quot;取消&quot;) }&#10;                        Spacer(modifier = Modifier.width(8.dp))&#10;&#10;                        // Button: 生成预览&#10;                        TextButton(onClick = {&#10;                            scope.launch {&#10;                                try {&#10;                                    isGenerating = true&#10;                                    val convText = if (includeConversation &amp;&amp; conversationMessages != null) {&#10;                                        conversationMessages.joinToString(separator = &quot;\n&quot;) { m -&gt;&#10;                                            val who = if (m.isUser) repository.getUserInfo().username else repository.getConversationRoleName(conversationId)&#10;                                            &quot;[${who}] ${m.text}&quot;&#10;                                        }&#10;                                    } else null&#10;&#10;                                    val promptHtml = when (selectedTemplate) {&#10;                                        &quot;poem&quot; -&gt; &quot;&lt;div style=\&quot;font-family: serif; padding:24px; text-align:center;\&quot;&gt;&lt;h2&gt;${title}&lt;/h2&gt;&lt;p&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/p&gt;&lt;footer style=\&quot;margin-top:16px;opacity:0.7;\&quot;&gt;— ${userInfo.username}&lt;/footer&gt;&lt;/div&gt;&quot;&#10;                                        &quot;card&quot; -&gt; &quot;&lt;div style=\&quot;font-family: sans-serif; padding:20px; border:1px solid #eee; border-radius:12px;\&quot;&gt;&lt;h3&gt;${title}&lt;/h3&gt;&lt;div&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/div&gt;&lt;/div&gt;&quot;&#10;                                        &quot;dialog&quot; -&gt; {&#10;                                            // load template from assets and fill with data&#10;                                            try {&#10;                                                val tpl = context.assets.open(&quot;ai_templates/dialog.html&quot;).bufferedReader().use { it.readText() }&#10;                                                val dataMap = mapOf(&#10;                                                    &quot;time&quot; to java.text.SimpleDateFormat(&quot;MMM dd, yyyy · HH:mm&quot;, java.util.Locale.getDefault()).format(java.util.Date(publishedAt)),&#10;                                                    &quot;userName&quot; to userInfo.username,&#10;                                                    &quot;userSig&quot; to userInfo.signature,&#10;                                                    &quot;aiName&quot; to repository.getConversationRoleName(conversationId),&#10;                                                    &quot;aiModel&quot; to repository.getSelectedModel(),&#10;                                                    &quot;aiPrompt&quot; to commentary,&#10;                                                    &quot;userContent&quot; to (convText ?: content),&#10;                                                    &quot;aiContent&quot; to &quot;&quot;&#10;                                                )&#10;                                                HtmlTemplateFiller.fillTemplate(tpl, dataMap)&#10;                                            } catch (_: Exception) {&#10;                                                // fallback to simple card HTML&#10;                                                &quot;&lt;div style=\&quot;font-family: system-ui; padding:16px;\&quot;&gt;&lt;h3&gt;${title}&lt;/h3&gt;&lt;div&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/div&gt;&lt;/div&gt;&quot;&#10;                                            }&#10;                                        }&#10;                                        else -&gt; &quot;&lt;div style=\&quot;font-family: system-ui; padding:16px;\&quot;&gt;&lt;h3&gt;${title}&lt;/h3&gt;&lt;div&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/div&gt;&lt;/div&gt;&quot;&#10;                                    }&#10;&#10;                                    val id = repository.createAICreationFromMessage(&#10;                                        title = title,&#10;                                        username = repository.getUserInfo().username,&#10;                                        userSignature = repository.getUserInfo().signature,&#10;                                        aiRoleName = repository.getConversationRoleName(conversationId),&#10;                                        aiModelName = repository.getSelectedModel(),&#10;                                        promptHtml = promptHtml,&#10;                                        promptJson = &quot;{\&quot;sourceConversationId\&quot;: \&quot;$conversationId\&quot;, \&quot;messageId\&quot;: \&quot;${message.id}\&quot;}&quot;,&#10;                                        conversationText = convText ?: content,&#10;                                        conversationAt = conversationAt,&#10;                                        publishedAt = publishedAt,&#10;                                        commentary = commentary&#10;                                    )&#10;&#10;                                    // remember id for publishing later&#10;                                    currentCreationId = id&#10;&#10;                                    // generate synchronously to get image immediately for preview&#10;                                    val ok = repository.generateAICreationNow(id)&#10;                                    if (ok) {&#10;                                        // load entity image path&#10;                                        val dao = AppDatabase.getDatabase(context).aiCreationDao()&#10;                                        val ent = withContext(Dispatchers.IO) { dao.getCreationById(id) }&#10;                                        val imgPath = ent?.imageFileName&#10;                                        if (!imgPath.isNullOrEmpty()) {&#10;                                            previewBmp = withContext(Dispatchers.IO) {&#10;                                                try {&#10;                                                    BitmapFactory.decodeFile(imgPath)&#10;                                                } catch (_: Exception) {&#10;                                                    null&#10;                                                }&#10;                                            }&#10;                                        } else {&#10;                                            previewBmp = null&#10;                                        }&#10;                                    } else {&#10;                                        withContext(Dispatchers.Main) {&#10;                                            Toast.makeText(context, &quot;生成失败，请稍后重试&quot;, Toast.LENGTH_SHORT).show()&#10;                                        }&#10;                                    }&#10;                                } catch (e: Exception) {&#10;                                    e.printStackTrace()&#10;                                    Toast.makeText(context, &quot;生成错误: ${e.message}&quot;, Toast.LENGTH_SHORT).show()&#10;                                } finally {&#10;                                    isGenerating = false&#10;                                }&#10;                            }&#10;                        }) { Text(&quot;生成预览&quot;) }&#10;&#10;                        Spacer(modifier = Modifier.width(8.dp))&#10;&#10;                        // Button: 发布（确保生成并标记为已发布）&#10;                        Button(onClick = {&#10;                            scope.launch {&#10;                                try {&#10;                                    isGenerating = true&#10;                                    // ensure we have an entity id&#10;                                    val id = currentCreationId ?: run {&#10;                                        val convText = if (includeConversation &amp;&amp; conversationMessages != null) {&#10;                                            conversationMessages.joinToString(separator = &quot;\n&quot;) { m -&gt;&#10;                                                val who = if (m.isUser) repository.getUserInfo().username else repository.getConversationRoleName(conversationId)&#10;                                                &quot;[${who}] ${m.text}&quot;&#10;                                            }&#10;                                        } else null&#10;&#10;                                        val promptHtml = when (selectedTemplate) {&#10;                                            &quot;poem&quot; -&gt; &quot;&lt;div style=\&quot;font-family: serif; padding:24px; text-align:center;\&quot;&gt;&lt;h2&gt;${title}&lt;/h2&gt;&lt;p&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/p&gt;&lt;footer style=\&quot;margin-top:16px;opacity:0.7;\&quot;&gt;— ${userInfo.username}&lt;/footer&gt;&lt;/div&gt;&quot;&#10;                                            &quot;card&quot; -&gt; &quot;&lt;div style=\&quot;font-family: sans-serif; padding:20px; border:1px solid #eee; border-radius:12px;\&quot;&gt;&lt;h3&gt;${title}&lt;/h3&gt;&lt;div&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/div&gt;&lt;/div&gt;&quot;&#10;                                            &quot;dialog&quot; -&gt; {&#10;                                                // load template from assets and fill with data&#10;                                                try {&#10;                                                    val tpl = context.assets.open(&quot;ai_templates/dialog.html&quot;).bufferedReader().use { it.readText() }&#10;                                                    val dataMap = mapOf(&#10;                                                        &quot;time&quot; to java.text.SimpleDateFormat(&quot;MMM dd, yyyy · HH:mm&quot;, java.util.Locale.getDefault()).format(java.util.Date(publishedAt)),&#10;                                                        &quot;userName&quot; to userInfo.username,&#10;                                                        &quot;userSig&quot; to userInfo.signature,&#10;                                                        &quot;aiName&quot; to repository.getConversationRoleName(conversationId),&#10;                                                        &quot;aiModel&quot; to repository.getSelectedModel(),&#10;                                                        &quot;aiPrompt&quot; to commentary,&#10;                                                        &quot;userContent&quot; to (convText ?: content),&#10;                                                        &quot;aiContent&quot; to &quot;&quot;&#10;                                                    )&#10;                                                    HtmlTemplateFiller.fillTemplate(tpl, dataMap)&#10;                                                } catch (_: Exception) {&#10;                                                    // fallback to simple card HTML&#10;                                                    &quot;&lt;div style=\&quot;font-family: system-ui; padding:16px;\&quot;&gt;&lt;h3&gt;${title}&lt;/h3&gt;&lt;div&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/div&gt;&lt;/div&gt;&quot;&#10;                                                }&#10;                                            }&#10;                                            else -&gt; &quot;&lt;div style=\&quot;font-family: system-ui; padding:16px;\&quot;&gt;&lt;h3&gt;${title}&lt;/h3&gt;&lt;div&gt;${commentary.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)}&lt;/div&gt;&lt;/div&gt;&quot;&#10;                                        }&#10;&#10;                                        repository.createAICreationFromMessage(&#10;                                            title = title,&#10;                                            username = repository.getUserInfo().username,&#10;                                            userSignature = repository.getUserInfo().signature,&#10;                                            aiRoleName = repository.getConversationRoleName(conversationId),&#10;                                            aiModelName = repository.getSelectedModel(),&#10;                                            promptHtml = promptHtml,&#10;                                            promptJson = &quot;{\&quot;sourceConversationId\&quot;: \&quot;$conversationId\&quot;, \&quot;messageId\&quot;: \&quot;${message.id}\&quot;}&quot;,&#10;                                            conversationText = convText ?: content,&#10;                                            conversationAt = conversationAt,&#10;                                            publishedAt = publishedAt,&#10;                                            commentary = commentary&#10;                                        )&#10;                                    }&#10;&#10;                                    // Generate if image missing&#10;                                    val dao = AppDatabase.getDatabase(context).aiCreationDao()&#10;                                    val ent = withContext(Dispatchers.IO) { dao.getCreationById(id) }&#10;                                    if (ent == null) {&#10;                                        withContext(Dispatchers.Main) {&#10;                                            Toast.makeText(context, &quot;创建失败&quot;, Toast.LENGTH_SHORT).show()&#10;                                        }&#10;                                        return@launch&#10;                                    }&#10;&#10;                                    if (ent.imageFileName.isNullOrEmpty()) {&#10;                                        val genOk = repository.generateAICreationNow(id)&#10;                                        if (!genOk) {&#10;                                            withContext(Dispatchers.Main) {&#10;                                                Toast.makeText(context, &quot;生成封面失败，已加入队列&quot;, Toast.LENGTH_SHORT).show()&#10;                                            }&#10;                                            // enqueue for background generation and still publish the post&#10;                                            repository.enqueueAICreationGeneration(id)&#10;                                        }&#10;                                    }&#10;&#10;                                    // mark published (suspend)&#10;                                    withContext(Dispatchers.IO) {&#10;                                        repository.publishAICreation(id)&#10;                                    }&#10;&#10;                                    // callback on main thread&#10;                                    withContext(Dispatchers.Main) {&#10;                                        onPublished(id)&#10;                                        Toast.makeText(context, &quot;已发布到 AI 创作&quot;, Toast.LENGTH_SHORT).show()&#10;                                    }&#10;&#10;                                    // dismiss editor&#10;                                    onDismiss()&#10;&#10;                                } catch (e: Exception) {&#10;                                    e.printStackTrace()&#10;                                    withContext(Dispatchers.Main) {&#10;                                        Toast.makeText(context, &quot;发布失败: ${e.message}&quot;, Toast.LENGTH_SHORT).show()&#10;                                    }&#10;                                } finally {&#10;                                    isGenerating = false&#10;                                }&#10;                            }&#10;                        }) {&#10;                            Text(&quot;发布并发布到 AI 创作&quot;)&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun AICreationDetail(&#10;    item: AICreationEntity,&#10;    repository: Repository,&#10;    onClose: () -&gt; Unit&#10;) {&#10;    val context = LocalContext.current&#10;    val scope = rememberCoroutineScope()&#10;    Dialog(onDismissRequest = onClose) {&#10;        Surface(modifier = Modifier.fillMaxSize(), color = MaterialTheme.colorScheme.background) {&#10;            Column(modifier = Modifier&#10;                .fillMaxSize()&#10;                .padding(0.dp)) {&#10;                TopAppBar(&#10;                    title = { Text(item.aiRoleName ?: &quot;AI 创作&quot;) },&#10;                    navigationIcon = {&#10;                        IconButton(onClick = onClose) {&#10;                            Icon(Icons.Default.Close, contentDescription = &quot;关闭&quot;)&#10;                        }&#10;                    }&#10;                )&#10;&#10;                val scroll = rememberScrollState()&#10;                Column(modifier = Modifier&#10;                    .fillMaxSize()&#10;                    .verticalScroll(scroll)&#10;                    .padding(12.dp)) {&#10;&#10;                    // Cover image with overlayed title/author placed on image&#10;                    Box(modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .height(360.dp)) {&#10;                        val bmp = item.imageFileName?.let { ImageStorage.loadBitmap(it) }&#10;                        if (bmp != null) {&#10;                            Image(bitmap = bmp.asImageBitmap(), contentDescription = &quot;题图&quot;, modifier = Modifier&#10;                                .fillMaxSize())&#10;                        } else {&#10;                            Box(modifier = Modifier&#10;                                .fillMaxSize()&#10;                                .background(MaterialTheme.colorScheme.surfaceVariant), contentAlignment = Alignment.Center) {&#10;                                Text(&quot;尚未生成题图&quot;)&#10;                            }&#10;                        }&#10;&#10;                        // dark translucent gradient-like overlay at bottom for text readability&#10;                        Box(modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .height(100.dp)&#10;                            .align(Alignment.BottomStart)&#10;                            .background(MaterialTheme.colorScheme.surface.copy(alpha = 0.6f))) {&#10;                            Column(modifier = Modifier&#10;                                .padding(12.dp), verticalArrangement = Arrangement.Center) {&#10;                                Text(text = item.title ?: &quot;无标题&quot;, style = MaterialTheme.typography.headlineSmall, fontWeight = FontWeight.Bold, color = MaterialTheme.colorScheme.onSurface)&#10;                                Spacer(modifier = Modifier.height(4.dp))&#10;                                Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {&#10;                                    Text(text = &quot;作者: ${item.username ?: &quot;匿名&quot;}&quot;, style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurface)&#10;                                    Text(text = &quot;AI 角色: ${item.aiRoleName ?: &quot;-&quot;}&quot;, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurface)&#10;                                }&#10;                            }&#10;                        }&#10;                    }&#10;&#10;                    Spacer(modifier = Modifier.height(12.dp))&#10;&#10;                    // Move metadata below image but reduce spacing&#10;                    Spacer(modifier = Modifier.height(6.dp))&#10;&#10;                    Text(text = &quot;对话时间: ${item.conversationAt?.let { formatTime(java.util.Date(it)) } ?: &quot;-&quot;}&quot;)&#10;                    Text(text = &quot;发布时间: ${item.publishedAt?.let { formatTime(java.util.Date(it)) } ?: formatTime(java.util.Date(item.createdAt))}&quot;)&#10;&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                    if (!item.commentary.isNullOrEmpty()) {&#10;                        Text(text = &quot;帖子正文&quot;, style = MaterialTheme.typography.titleMedium)&#10;                        Spacer(modifier = Modifier.height(4.dp))&#10;                        Text(text = item.commentary, style = MaterialTheme.typography.bodyMedium)&#10;                        Spacer(modifier = Modifier.height(8.dp))&#10;                    }&#10;&#10;                    val convText = item.conversationText&#10;                    if (!convText.isNullOrEmpty()) {&#10;                        Text(text = &quot;对话内容&quot;, style = MaterialTheme.typography.titleMedium)&#10;                        Spacer(modifier = Modifier.height(4.dp))&#10;                        Text(text = convText, style = MaterialTheme.typography.bodySmall)&#10;                        Spacer(modifier = Modifier.height(12.dp))&#10;                    }&#10;&#10;                    // Actions: regenerate, share, delete&#10;                    Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.End) {&#10;                        TextButton(onClick = {&#10;                            scope.launch {&#10;                                repository.enqueueAICreationGeneration(item.id)&#10;                                Toast.makeText(context, &quot;已开始重新生成&quot;, Toast.LENGTH_SHORT).show()&#10;                                onClose()&#10;                            }&#10;                        }) { Text(&quot;重新生成&quot;) }&#10;&#10;                        Spacer(modifier = Modifier.width(8.dp))&#10;&#10;                        TextButton(onClick = {&#10;                            try {&#10;                                val f = File(item.imageFileName ?: &quot;&quot;)&#10;                                if (f.exists()) {&#10;                                    val authority = &quot;com.chenhongyu.huajuan.fileprovider&quot;&#10;                                    val uri: Uri = FileProvider.getUriForFile(context, authority, f)&#10;                                    val shareIntent = Intent(Intent.ACTION_SEND).apply {&#10;                                        type = &quot;image/*&quot;&#10;                                        putExtra(Intent.EXTRA_STREAM, uri)&#10;                                        addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)&#10;                                    }&#10;                                    val chooser = Intent.createChooser(shareIntent, &quot;分享图片&quot;)&#10;                                    chooser.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)&#10;                                    context.startActivity(chooser)&#10;                                } else {&#10;                                    Toast.makeText(context, &quot;图片不存在，无法分享&quot;, Toast.LENGTH_SHORT).show()&#10;                                }&#10;                            } catch (_: Exception) {&#10;                                Toast.makeText(context, &quot;分享失败&quot;, Toast.LENGTH_SHORT).show()&#10;                            }&#10;                        }) { Text(&quot;分享&quot;) }&#10;&#10;                        Spacer(modifier = Modifier.width(8.dp))&#10;&#10;                        TextButton(onClick = {&#10;                            scope.launch {&#10;                                try {&#10;                                    repository.deleteAICreation(item.id)&#10;                                    Toast.makeText(context, &quot;已删除&quot;, Toast.LENGTH_SHORT).show()&#10;                                } catch (_: Exception) {&#10;                                    Toast.makeText(context, &quot;删除失败&quot;, Toast.LENGTH_SHORT).show()&#10;                                } finally {&#10;                                    onClose()&#10;                                }&#10;                            }&#10;                        }) { Text(&quot;删除&quot;) }&#10;                    }&#10;&#10;                    Spacer(modifier = Modifier.height(16.dp))&#10;                }&#10;            }&#10;        }&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>